<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ShelfSignals Preview ‚Äì Sekula Library</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #f3f4f6;
      --surface: #ffffff;
      --surface-alt: #f8fafc;
      --primary: #0f172a;
      --accent: #2563eb;
      --muted: #6b7280;
      --border: #e5e7eb;
      --chip-bg: #e0e7ff;
      --shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
    }

    body[data-theme="dark"] {
      --bg: #0b1220;
      --surface: #0f172a;
      --surface-alt: #111827;
      --primary: #e5e7eb;
      --accent: #60a5fa;
      --muted: #9ca3af;
      --border: #1f2937;
      --chip-bg: #1f2937;
      --shadow: 0 14px 32px rgba(0, 0, 0, 0.35);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, var(--bg), var(--surface-alt));
      color: var(--primary);
    }

    header {
      padding: 1rem 1.5rem;
      border: 1px solid var(--border);
      background: var(--surface);
      position: sticky;
      top: 0.75rem;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      flex-wrap: wrap;
      border-radius: 0.85rem;
      margin: 0.75rem 0.75rem 0;
      box-shadow: var(--shadow);
    }

    header h1 {
      margin: 0;
      font-size: 1.2rem;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    header p {
      margin: 0.3rem 0 0;
      font-size: 0.9rem;
      color: var(--muted);
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    main.layout {
      display: grid;
      grid-template-columns: 260px minmax(0, 2.2fr) minmax(280px, 1.3fr);
      gap: 1rem;
      padding: 1rem 1.5rem 1.5rem;
    }

    @media (max-width: 960px) {
      main.layout {
        grid-template-columns: 1fr;
        padding: 0.75rem;
        gap: 0.75rem;
      }
      aside.detail { order: 3; }
      section.controls { order: 1; }
      section.shelf-view { order: 2; }
      
      header {
        padding: 0.75rem 1rem;
      }
      
      header h1 {
        font-size: 1rem;
      }
      
      header p {
        font-size: 0.8rem;
      }
      
      .palette-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 600px) {
      header h1 {
        font-size: 0.9rem;
      }
      
      .spines {
        gap: 0.15rem;
      }
    }

    section.controls, section.shelf-view, aside.detail {
      background: var(--surface);
      border-radius: 0.75rem;
      border: 1px solid var(--border);
      padding: 0.75rem 1rem 1rem;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    section.controls h2,
    section.shelf-view h2,
    aside.detail h2 {
      margin: 0 0 0.5rem;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
    }

    .filter-group {
      margin-bottom: 0.75rem;
    }

    .filter-group input[type="text"] {
      width: 100%;
      padding: 0.45rem 0.5rem;
      border: 1px solid var(--border);
      border-radius: 0.35rem;
      font-size: 0.9rem;
    }

    .filter-group label {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      margin-bottom: 0.3rem;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .filter-group input[type="checkbox"] {
      cursor: pointer;
    }

    .search-wrapper {
      position: relative;
    }

    .search-clear {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 1.1rem;
      padding: 0.2rem;
      display: none;
    }

    .search-clear:hover {
      color: var(--primary);
    }

    .search-clear.visible {
      display: block;
    }

    .legend {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .legend-chip {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      font-size: 0.85rem;
    }

    .symbol {
      width: 1.4rem;
      height: 1.4rem;
      border: 2px solid var(--primary);
      display: inline-block;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .shelf-rows {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      margin-top: 0.5rem;
    }

    .shelf-row {
      border: 1px solid var(--border);
      border-radius: 0.45rem;
      padding: 0.5rem 0.6rem;
      background: var(--surface-alt);
      box-shadow: var(--shadow);
    }

    .shelf-row.dimmed {
      opacity: 0.4;
    }

    .shelf-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .shelf-label {
      font-weight: 700;
      font-size: 0.95rem;
    }

    .shelf-count {
      font-size: 0.82rem;
      color: var(--muted);
    }

    .spines {
      display: flex;
      flex-wrap: wrap;
      gap: 0.2rem;
      align-items: flex-end;
    }

    .spine {
      width: 8px;
      background: var(--accent);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
      position: relative;
      border-radius: 2px;
    }

    .spine:hover {
      transform: translateY(-2px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    .spine.selected {
      border-color: #000;
      border-width: 2px;
      transform: translateY(-3px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.25);
    }

    .spine.dimmed {
      opacity: 0.3;
    }

    .detail-body {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .detail-section {
      border: 1px solid var(--border);
      border-radius: 0.6rem;
      padding: 0.75rem;
      background: var(--surface-alt);
      box-shadow: var(--shadow);
    }

    .detail-section h3 {
      margin: 0 0 0.4rem;
      font-size: 0.9rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .detail-item {
      margin-bottom: 0.4rem;
      padding-bottom: 0.4rem;
      border-bottom: 1px solid var(--border);
    }

    .detail-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .detail-title {
      font-weight: 600;
      font-size: 0.9rem;
      margin-bottom: 0.2rem;
    }

    .detail-meta {
      font-size: 0.8rem;
      color: var(--muted);
      line-height: 1.4;
    }

    .signal-badge {
      display: inline-block;
      padding: 0.15rem 0.4rem;
      border-radius: 0.25rem;
      background: var(--chip-bg);
      font-size: 0.75rem;
      margin-right: 0.25rem;
      margin-bottom: 0.25rem;
    }

    .link-button {
      border: 1px solid var(--border);
      background: linear-gradient(135deg, var(--surface-alt), var(--surface));
      border-radius: 0.45rem;
      padding: 0.35rem 0.65rem;
      font-size: 0.85rem;
      cursor: pointer;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, transform 0.12s ease, background 0.12s ease;
      text-decoration: none;
      color: var(--primary);
      display: inline-block;
    }

    .link-button:hover {
      border-color: var(--accent);
      box-shadow: 0 6px 16px rgba(15,23,42,0.12);
      transform: translateY(-1px);
      background: var(--accent);
      color: #fff;
    }

    .muted {
      color: var(--muted);
    }

    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      font-size: 1.1rem;
      color: var(--muted);
      backdrop-filter: blur(2px);
    }

    body[data-theme="dark"] .loading-overlay {
      background: rgba(11, 17, 32, 0.9);
      color: var(--primary);
    }

    .empty-state {
      padding: 2rem 1rem;
      text-align: center;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .class-legend {
      margin: 0.5rem 0;
      padding: 0.5rem;
      background: var(--surface-alt);
      border-radius: 0.4rem;
      display: none;
      box-shadow: var(--shadow);
    }

    .class-legend.visible {
      display: block;
    }

    .class-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      margin: 0.2rem 0.3rem 0.2rem 0;
      font-size: 0.8rem;
    }

    .swatch {
      width: 1rem;
      height: 1rem;
      border-radius: 2px;
      border: 1px solid #999;
    }

    /* Accessibility enhancements */
    .spine:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    button:focus, .link-button:focus {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    [role="button"] {
      cursor: pointer;
    }

    /* Dialog/modal styles */
    .config-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    .config-dialog {
      background: var(--surface);
      border-radius: 0.5rem;
      padding: 1.5rem;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .config-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .config-header h2 {
      margin: 0;
      font-size: 1.1rem;
    }

    .palette-grid {
      display: grid;
      gap: 0.75rem;
    }

    .palette-card {
      border: 2px solid var(--border);
      border-radius: 0.4rem;
      padding: 0.75rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .palette-card:hover {
      border-color: var(--accent);
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .palette-card[data-active="true"] {
      border-color: var(--accent);
      background: #f0f7ff;
    }

    .swatch-row {
      display: flex;
      gap: 0.3rem;
      margin-top: 0.5rem;
    }

    .swatch-square {
      width: 2rem;
      height: 2rem;
      border-radius: 0.25rem;
      border: 1px solid #999;
    }

    /* About Modal */
    .about-modal {
      background: var(--surface);
      border-radius: 0.5rem;
      padding: 1.5rem;
      width: min(600px, 90vw);
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
    }

    .about-modal h3 {
      margin: 0 0 1rem;
      font-size: 1.4rem;
      color: var(--primary);
    }

    .about-modal h4 {
      margin: 1.2rem 0 0.5rem;
      font-size: 1rem;
      color: var(--primary);
    }

    .about-modal p {
      margin: 0.5rem 0;
      line-height: 1.6;
      color: var(--primary);
    }

    .about-modal ul {
      margin: 0.5rem 0;
      padding-left: 1.5rem;
      line-height: 1.6;
    }

    .about-modal a {
      color: var(--accent);
      text-decoration: none;
    }

    .about-modal a:hover {
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      .config-dialog, .about-modal {
        width: 95vw;
        padding: 1rem;
      }
      
      .about-modal h3 {
        font-size: 1.2rem;
      }
    }

    /* Book Modal Viewer */
    .book-modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 300;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    .book-modal-backdrop.active {
      display: flex;
    }

    .book-modal {
      background: var(--surface);
      border-radius: 0.75rem;
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      position: relative;
      border: 1px solid var(--border);
    }

    .book-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 1.5rem 1.5rem 1rem;
      border-bottom: 1px solid var(--border);
      gap: 1rem;
    }

    .book-modal-title-section {
      flex: 1;
      min-width: 0;
    }

    .book-modal-title {
      font-size: 1.3rem;
      font-weight: 700;
      margin: 0 0 0.5rem;
      line-height: 1.3;
      color: var(--primary);
    }

    .book-modal-meta {
      font-size: 0.9rem;
      color: var(--muted);
      line-height: 1.5;
    }

    .book-modal-close {
      background: transparent;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.25rem;
      color: var(--muted);
      flex-shrink: 0;
      line-height: 1;
    }

    .book-modal-close:hover {
      color: var(--primary);
    }

    .book-modal-body {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }

    .book-modal-section {
      margin-bottom: 1.5rem;
    }

    .book-modal-section:last-child {
      margin-bottom: 0;
    }

    .book-modal-section h3 {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--muted);
      margin: 0 0 0.75rem;
    }

    .book-modal-description {
      line-height: 1.6;
      color: var(--primary);
    }

    .book-modal-subjects {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .subject-tag {
      background: var(--chip-bg);
      padding: 0.3rem 0.6rem;
      border-radius: 0.3rem;
      font-size: 0.85rem;
    }

    .book-modal-links {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .modal-link {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1rem;
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 0.5rem;
      text-decoration: none;
      color: var(--primary);
      font-weight: 500;
      transition: all 0.15s ease;
    }

    .modal-link:hover {
      border-color: var(--accent);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .modal-link-icon {
      font-size: 1.2rem;
    }

    .book-modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .modal-nav-buttons {
      display: flex;
      gap: 0.5rem;
    }

    .modal-nav-button {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 0.4rem;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.15s ease;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .modal-nav-button:hover:not(:disabled) {
      border-color: var(--accent);
      background: #f0f7ff;
    }

    .modal-nav-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .modal-action-buttons {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    .modal-action-button {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 0.4rem;
      padding: 0.6rem 1.2rem;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: all 0.15s ease;
    }

    .modal-action-button:hover {
      background: #1565a0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .modal-action-button.secondary {
      background: var(--surface);
      color: var(--primary);
      border: 2px solid var(--border);
    }

    .modal-action-button.secondary:hover {
      border-color: var(--accent);
      background: var(--surface-alt);
    }

    /* Cart/Shelf Panel */
    .cart-badge {
      position: relative;
      cursor: pointer;
    }

    .cart-count {
      position: absolute;
      top: -8px;
      right: -8px;
      background: #e74c3c;
      color: #fff;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
    }

    .cart-panel {
      display: none;
      position: fixed;
      right: 0;
      top: 0;
      bottom: 0;
      width: min(400px, 90vw);
      background: var(--surface);
      box-shadow: -4px 0 20px rgba(0,0,0,0.2);
      z-index: 250;
      flex-direction: column;
    }

    .cart-panel.active {
      display: flex;
    }

    .cart-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .cart-header h2 {
      margin: 0;
      font-size: 1.2rem;
    }

    .cart-body {
      flex: 1;
      overflow-y: auto;
      padding: 1rem;
    }

    .cart-item {
      border: 1px solid var(--border);
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.75rem;
      background: var(--surface-alt);
    }

    .cart-item-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.3rem;
    }

    .cart-item-meta {
      font-size: 0.8rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }

    .cart-item-actions {
      display: flex;
      gap: 0.5rem;
    }

    .cart-item-button {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 0.3rem;
      padding: 0.3rem 0.6rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .cart-item-button:hover {
      border-color: var(--accent);
      background: #f0f7ff;
    }

    .cart-item-button.remove {
      border-color: #e74c3c;
      color: #e74c3c;
    }

    .cart-item-button.remove:hover {
      background: #ffe6e6;
    }

    .cart-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 0.5rem;
      flex-direction: column;
    }

    .cart-empty {
      text-align: center;
      padding: 3rem 1.5rem;
      color: var(--muted);
    }

    @media (max-width: 600px) {
      .book-modal {
        max-width: 100%;
        border-radius: 0;
        max-height: 100vh;
      }

      .book-modal-header, .book-modal-body, .book-modal-footer {
        padding: 1rem;
      }

      .book-modal-title {
        font-size: 1.1rem;
      }

      .modal-nav-buttons, .modal-action-buttons {
        width: 100%;
      }

      .modal-nav-button, .modal-action-button {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div id="loadingOverlay" class="loading-overlay">
    <div>Loading Sekula Library data...</div>
  </div>

  <div id="aboutBackdrop" class="config-backdrop" role="dialog" aria-labelledby="aboutTitle" aria-modal="true">
    <div class="about-modal">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
        <h3 id="aboutTitle" style="margin:0;">About ShelfSignals</h3>
        <button id="closeAbout" class="link-button" aria-label="Close about dialog">‚úï</button>
      </div>
      <p>
        <strong>ShelfSignals</strong> is a system-agnostic analytics framework for extracting structure,
        patterns, and insights from collection inventories. It is designed for research
        libraries, archives, and any environment where catalog metadata and numbering
        systems contain implicit signals about provenance, organization, or workflow history.
      </p>
      
      <h4>Current Version: Preview v2.x</h4>
      <p>
        You are viewing the <strong>experimental preview environment</strong>. This version showcases 
        modernized architecture with modular JavaScript utilities, enhanced accessibility, and 
        JSON-native data loading from the Primo API.
      </p>
      <p style="background:var(--chip-bg);padding:0.75rem;border-radius:4px;margin:0.5rem 0;">
        <strong>Need stability?</strong> Switch to the 
        <a href="../" style="color:var(--accent);">Production Interface (v1.x) ‚Üí</a><br>
        <span style="font-size:0.85rem;color:var(--muted);">
          Uses proven workflows with CSV-based data loading and stable feature set.
        </span>
      </p>
      
      <h4>Background</h4>
      <p>
        This prototype visualizes the <strong>Allan Sekula Library</strong>, a research collection focused on 
        photography, labor, maritime culture, and critical theory. The library contains materials 
        that span art, politics, geography, and social documentary. ShelfSignals reveals thematic 
        patterns and organizational structures through visual analysis of call numbers, subjects, 
        and provenance metadata.
      </p>
      
      <h4>Preview Environment</h4>
      <p>
        This preview site showcases a modernized, modular architecture with JSON-native data loading 
        from the Primo API. It features improved accessibility (ARIA roles, keyboard navigation), 
        enhanced search capabilities, and modular JavaScript utilities for LC call-number parsing, 
        signal detection, and color management.
      </p>
      
      <h4>Features</h4>
      <ul>
        <li><strong>Signal Detection:</strong> Automatically identifies thematic signals (image, labor, capital, sea, etc.) from subject headings and notes</li>
        <li><strong>Visual Shelf Representation:</strong> Displays collection as interactive "spines" grouped by LC class</li>
        <li><strong>Search & Filter:</strong> Debounced real-time search with match highlighting across titles, authors, and subjects</li>
        <li><strong>Color Coding:</strong> Multiple accessible color palettes for LC class visualization</li>
        <li><strong>Enhanced Accessibility:</strong> Full keyboard navigation, ARIA labels, and focus management</li>
      </ul>
      
      <h4>Scope</h4>
      <p>
        ShelfSignals ingests catalog records, normalizes metadata, and uses configurable
        analysis modules to detect patterns in:
      </p>
      <ul>
        <li>Numbering sequences and LC call number clustering</li>
        <li>Subject heading patterns and keyword analysis</li>
        <li>Provenance and physical location distributions</li>
        <li>Temporal groupings and publication patterns</li>
      </ul>
      
      <h4>Technology</h4>
      <p>
        This is a modern client-side web application built with vanilla ES6+ JavaScript modules, 
        CSS Grid, and web standards. Data is loaded from JSON exports of the Primo API. 
        The modular architecture includes separate utilities for signals, LC parsing, colors, 
        search state, and year normalization.
      </p>
      
      <p style="margin-top:1.5rem;padding-top:1rem;border-top:1px solid var(--border);font-size:0.85rem;color:var(--muted);">
        For more information, visit the 
        <a href="https://github.com/evcatalyst/ShelfSignals" target="_blank" rel="noopener noreferrer">ShelfSignals GitHub repository</a>.
      </p>
    </div>
  </div>

  <div id="configBackdrop" class="config-backdrop" role="dialog" aria-labelledby="configTitle" aria-modal="true">
    <div class="config-dialog">
      <div class="config-header">
        <h2 id="configTitle">Color Settings</h2>
        <button id="closeConfig" class="link-button" aria-label="Close settings">‚úï</button>
      </div>
      <div id="paletteGrid" class="palette-grid"></div>
    </div>
  </div>

  <!-- Book Modal -->
  <div id="bookModalBackdrop" class="book-modal-backdrop" role="dialog" aria-labelledby="bookModalTitle" aria-modal="true">
    <div class="book-modal">
      <div class="book-modal-header">
        <div class="book-modal-title-section">
          <h2 id="bookModalTitle" class="book-modal-title"></h2>
          <div id="bookModalMeta" class="book-modal-meta"></div>
        </div>
        <button id="closeBookModal" class="book-modal-close" aria-label="Close book details">‚úï</button>
      </div>
      <div id="bookModalBody" class="book-modal-body"></div>
      <div class="book-modal-footer">
        <div class="modal-nav-buttons">
          <button id="modalPrevBook" class="modal-nav-button">
            <span>‚Üê</span>
            <span>Previous</span>
          </button>
          <button id="modalNextBook" class="modal-nav-button">
            <span>Next</span>
            <span>‚Üí</span>
          </button>
        </div>
        <div class="modal-action-buttons">
          <button id="addToCart" class="modal-action-button secondary">Add to Cart</button>
          <button id="addToShelf" class="modal-action-button">Add to Shelf</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart/Shelf Panel -->
  <div id="cartPanel" class="cart-panel">
    <div class="cart-header">
      <h2 id="cartPanelTitle">My Shelf</h2>
      <button id="closeCart" class="link-button" aria-label="Close shelf">‚úï</button>
    </div>
    <div id="cartBody" class="cart-body"></div>
    <div class="cart-footer">
      <button id="clearCart" class="modal-action-button secondary" style="width:100%;">Clear All</button>
      <button id="exportCart" class="modal-action-button" style="width:100%;">Export List</button>
    </div>
  </div>

  <header>
    <div>
      <h1>ShelfSignals Preview</h1>
      <p>Preview v2.x ‚Äì Experimental Features <span style="margin-left:0.5rem;">¬∑</span> <a href="../" style="color:var(--accent);text-decoration:none;">‚Üê Back to Production v1.x</a></p>
    </div>
    <div class="header-controls">
      <button id="toggleTheme" class="link-button" aria-label="Toggle theme">üåô</button>
      <button id="openAbout" class="link-button">About</button>
      <button id="openConfig" class="link-button">Color Settings</button>
      <button id="openCart" class="link-button cart-badge">
        üìö My Shelf
        <span id="cartCount" class="cart-count" style="display:none;">0</span>
      </button>
    </div>
  </header>

  <main class="layout">
    <section class="controls">
      <h2>Signals</h2>
      <div id="signalFilters" class="filter-group"></div>
      
      <div class="filter-group">
        <label for="searchBox" style="font-weight:600;font-size:0.9rem;">Search</label>
        <div class="search-wrapper">
          <input id="searchBox" type="text" placeholder="Search titles, authors, subjects..." aria-label="Search library items" />
          <button id="searchClear" class="search-clear" aria-label="Clear search">‚úï</button>
        </div>
        <div id="searchMeta" class="muted" style="font-size:0.75rem;margin-top:0.3rem;"></div>
      </div>

      <div class="filter-group">
        <label style="display:flex;align-items:center;gap:0.35rem;font-weight:600;font-size:0.9rem;">
          <input id="toggleClassColors" type="checkbox" aria-label="Color spines by LC class"> Color by LC class
        </label>
      </div>

      <div class="filter-group">
        <label style="display:flex;align-items:center;gap:0.35rem;font-weight:600;font-size:0.9rem;">
          <input id="togglePhotoOverlay" type="checkbox" aria-label="Show photo likelihood overlay"> üì∑ Embedded Photography
        </label>
        <div id="photoFilterGroup" style="margin-left:1.5rem;margin-top:0.4rem;display:none;">
          <label style="font-size:0.85rem;color:var(--muted);margin-bottom:0.3rem;display:block;">Filter by likelihood:</label>
          <label style="display:flex;align-items:center;gap:0.3rem;margin-bottom:0.2rem;font-size:0.85rem;">
            <input type="checkbox" class="photo-bucket-filter" value="Strongly Likely" checked> Strongly Likely (‚â•75)
          </label>
          <label style="display:flex;align-items:center;gap:0.3rem;margin-bottom:0.2rem;font-size:0.85rem;">
            <input type="checkbox" class="photo-bucket-filter" value="Likely" checked> Likely (55-74)
          </label>
          <label style="display:flex;align-items:center;gap:0.3rem;margin-bottom:0.2rem;font-size:0.85rem;">
            <input type="checkbox" class="photo-bucket-filter" value="Plausible" checked> Plausible (35-54)
          </label>
          <label style="display:flex;align-items:center;gap:0.3rem;margin-bottom:0.2rem;font-size:0.85rem;">
            <input type="checkbox" class="photo-bucket-filter" value="Unlikely" checked> Unlikely (<35)
          </label>
        </div>
      </div>

      <h2>Legend</h2>
      <div id="signalLegend" class="legend"></div>
      <div id="photoLegend" style="display:none;margin-top:1rem;padding-top:0.75rem;border-top:1px solid var(--border);">
        <h3 style="margin:0 0 0.5rem;font-size:0.85rem;text-transform:uppercase;letter-spacing:0.06em;color:var(--muted);">üì∑ Photo Likelihood</h3>
        <div style="font-size:0.8rem;color:var(--muted);margin-bottom:0.5rem;">
          Probabilistic estimate of embedded photographic content based on metadata analysis.
        </div>
        <div class="legend-chip" style="margin-bottom:0.25rem;">
          <div style="width:1.4rem;height:1.4rem;background:rgba(255,165,0,0.4);border:2px solid rgba(255,140,0,0.8);border-radius:3px;"></div>
          <span style="font-size:0.8rem;">Strongly Likely (‚â•75)</span>
        </div>
        <div class="legend-chip" style="margin-bottom:0.25rem;">
          <div style="width:1.4rem;height:1.4rem;background:rgba(255,215,0,0.3);border:2px solid rgba(255,185,0,0.6);border-radius:3px;"></div>
          <span style="font-size:0.8rem;">Likely (55-74)</span>
        </div>
        <div class="legend-chip" style="margin-bottom:0.25rem;">
          <div style="width:1.4rem;height:1.4rem;background:rgba(135,206,250,0.2);border:2px solid rgba(70,130,180,0.4);border-radius:3px;"></div>
          <span style="font-size:0.8rem;">Plausible (35-54)</span>
        </div>
        <div style="font-size:0.75rem;color:var(--muted);margin-top:0.4rem;">
          Conservative scoring: high scores require converging evidence from metadata, domain, and format signals.
        </div>
      </div>
    </section>

    <section class="shelf-view">
      <h2>Collection View</h2>
      <div id="shelfSummary" class="muted" style="font-size:0.85rem;margin-bottom:0.5rem;"></div>
      <div id="classLegend" class="class-legend"></div>
      <div id="shelfRows" class="shelf-rows"></div>
      <div id="emptyState" class="empty-state" style="display:none;">
        No items match the current filters. Try adjusting your search or signal selections.
      </div>
    </section>

    <aside class="detail">
      <h2>Details</h2>
      <div id="detailIntro" class="muted" style="font-size:0.85rem;">
        Click on a spine to see details.
      </div>
      <div id="detailBody" class="detail-body"></div>
    </aside>
  </main>

  <script type="module">
    // Import modular utilities
    import { SIGNALS, SIGNAL_IDS, SIGNAL_LABELS, deriveSignals } from '../js/signals.js';
    import { parseLcCallNumber } from '../js/lc.js';
    import { getSpineColor, getActivePalette, setActivePalette, getPalettes } from '../js/colors.js';
    import { searchState } from '../js/search.js';
    import { normalizeYear } from '../js/year.js';

    // State
    let inventory = [];
    let enrichedInventory = [];
    let selectedItem = null;
    let selectionLost = false;
    const activeSignals = new Set(SIGNAL_IDS);
    let colorMode = 'signals';
    let activePalette = getActivePalette();
    const SIGNAL_META_MAP = new Map(SIGNALS.map(s => [s.id, s]));
    const MAX_SAMPLE_POOL_SIZE = 200;
    const MAX_SAMPLE_TITLES = 10;
    
    // Photo overlay state
    let photoOverlayEnabled = false;
    const activePhotoBuckets = new Set(['Strongly Likely', 'Likely', 'Plausible', 'Unlikely']);

    // Theme persistence
    const THEME_KEY = 'shelfsignals_preview_theme';

    function applyTheme(mode) {
      const normalized = mode === 'dark' ? 'dark' : 'light';
      document.body.dataset.theme = normalized;
      const toggle = document.getElementById('toggleTheme');
      if (toggle) {
        toggle.textContent = normalized === 'dark' ? 'üåû' : 'üåô';
        toggle.setAttribute('aria-label', normalized === 'dark' ? 'Switch to light mode' : 'Switch to dark mode');
      }
      try {
        localStorage.setItem(THEME_KEY, normalized);
      } catch (_) {
        // ignore storage errors
      }
    }

    function initTheme() {
      let initial = 'light';
      try {
        initial = localStorage.getItem(THEME_KEY) || initial;
      } catch (_) {
        // ignore storage errors
      }
      if (initial !== 'dark' && window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        initial = 'dark';
      }
      applyTheme(initial);
    }

    // Memoization caches
    const renderCache = new Map();

    // Modal and cart state
    let modalCurrentIndex = -1;
    let modalFilteredItems = [];
    let shelf = [];
    const SHELF_STORAGE_KEY = 'shelfsignals_shelf';

    // Cart/Shelf Management
    function loadShelf() {
      try {
        const stored = localStorage.getItem(SHELF_STORAGE_KEY);
        return stored ? JSON.parse(stored) : [];
      } catch (e) {
        console.error('Failed to load shelf:', e);
        return [];
      }
    }

    function saveShelf() {
      try {
        localStorage.setItem(SHELF_STORAGE_KEY, JSON.stringify(shelf));
        updateCartBadge();
      } catch (e) {
        console.error('Failed to save shelf:', e);
      }
    }

    function addToShelf(item) {
      if (!shelf.find(i => i.id === item.id)) {
        shelf.push({
          id: item.id,
          title: item.title,
          authors: item.authors,
          yearPrimary: item.yearPrimary,
          call_number: item.call_number,
          catalogLink: item.catalogLink,
          signals: item.signals
        });
        saveShelf();
        renderCartPanel();
        showNotification(`Added "${item.title}" to shelf`);
      } else {
        showNotification(`"${item.title}" is already in your shelf`);
      }
    }

    function removeFromShelf(id) {
      shelf = shelf.filter(i => i.id !== id);
      saveShelf();
      renderCartPanel();
    }

    function clearShelf() {
      if (confirm('Clear all items from your shelf?')) {
        shelf = [];
        saveShelf();
        renderCartPanel();
        showNotification('Shelf cleared');
      }
    }

    function exportShelf() {
      if (shelf.length === 0) {
        showNotification('Your shelf is empty');
        return;
      }
      
      const text = shelf.map((item, i) => 
        `${i + 1}. ${item.title}` +
        (item.authors && item.authors.length ? ` ‚Äî ${item.authors.join(', ')}` : '') +
        (item.yearPrimary ? ` (${item.yearPrimary})` : '') +
        (item.call_number ? ` [${item.call_number}]` : '') +
        (item.catalogLink ? `\\n   ${item.catalogLink}` : '')
      ).join('\\n\\n');
      
      const blob = new Blob([text], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `shelfsignals-shelf-${new Date().toISOString().split('T')[0]}.txt`;
      a.click();
      URL.revokeObjectURL(url);
      showNotification('Shelf exported');
    }

    function updateCartBadge() {
      const badge = document.getElementById('cartCount');
      if (shelf.length > 0) {
        badge.textContent = shelf.length;
        badge.style.display = 'flex';
      } else {
        badge.style.display = 'none';
      }
    }

    function renderCartPanel() {
      const body = document.getElementById('cartBody');
      body.innerHTML = '';
      
      if (shelf.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'cart-empty';
        empty.innerHTML = 'üìö<br><br>Your shelf is empty<br><small style="color:var(--muted);">Click "Add to Shelf" on any book to save it here</small>';
        body.appendChild(empty);
        return;
      }
      
      for (const item of shelf) {
        const card = document.createElement('div');
        card.className = 'cart-item';
        
        const title = document.createElement('div');
        title.className = 'cart-item-title';
        title.textContent = item.title;
        card.appendChild(title);
        
        const meta = document.createElement('div');
        meta.className = 'cart-item-meta';
        const parts = [];
        if (item.authors && item.authors.length) parts.push(item.authors.join(', '));
        if (item.yearPrimary) parts.push(item.yearPrimary);
        if (item.call_number) parts.push(item.call_number);
        meta.textContent = parts.join(' ¬∑ ');
        card.appendChild(meta);
        
        if (item.signals && item.signals.length) {
          const badges = document.createElement('div');
          badges.style.marginBottom = '0.5rem';
          item.signals.forEach(sig => {
            const badge = document.createElement('span');
            badge.className = 'signal-badge';
            badge.textContent = SIGNAL_LABELS[sig];
            badges.appendChild(badge);
          });
          card.appendChild(badges);
        }
        
        const actions = document.createElement('div');
        actions.className = 'cart-item-actions';
        
        if (item.catalogLink) {
          const viewBtn = document.createElement('a');
          viewBtn.href = item.catalogLink;
          viewBtn.target = '_blank';
          viewBtn.rel = 'noopener noreferrer';
          viewBtn.className = 'cart-item-button';
          viewBtn.textContent = 'View';
          actions.appendChild(viewBtn);
        }
        
        const removeBtn = document.createElement('button');
        removeBtn.className = 'cart-item-button remove';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', () => removeFromShelf(item.id));
        actions.appendChild(removeBtn);
        
        card.appendChild(actions);
        body.appendChild(card);
      }
    }

    function showNotification(message) {
      // Simple toast notification
      const toast = document.createElement('div');
      toast.style.cssText = 'position:fixed;bottom:2rem;right:2rem;background:#333;color:#fff;padding:1rem 1.5rem;border-radius:0.5rem;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1000;font-size:0.9rem;';
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.transition = 'opacity 0.3s ease';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 2000);
    }

    // Book Modal Management
    function openBookModal(item, filteredItems) {
      modalFilteredItems = filteredItems;
      modalCurrentIndex = filteredItems.findIndex(i => i.id === item.id);
      
      if (modalCurrentIndex === -1) {
        modalFilteredItems = [item];
        modalCurrentIndex = 0;
      }
      
      renderBookModal(item);
      
      const backdrop = document.getElementById('bookModalBackdrop');
      backdrop.classList.add('active');
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
      
      // Focus close button
      document.getElementById('closeBookModal').focus();
    }

    function closeBookModal() {
      const backdrop = document.getElementById('bookModalBackdrop');
      backdrop.classList.remove('active');
      document.body.style.overflow = '';
    }

    function navigateModal(direction) {
      const newIndex = modalCurrentIndex + direction;
      if (newIndex >= 0 && newIndex < modalFilteredItems.length) {
        modalCurrentIndex = newIndex;
        renderBookModal(modalFilteredItems[modalCurrentIndex]);
      }
    }

    function renderBookModal(item) {
      const title = document.getElementById('bookModalTitle');
      const meta = document.getElementById('bookModalMeta');
      const body = document.getElementById('bookModalBody');
      const prevBtn = document.getElementById('modalPrevBook');
      const nextBtn = document.getElementById('modalNextBook');
      
      title.textContent = item.title || 'Untitled';
      
      const metaParts = [];
      if (item.authors && item.authors.length) metaParts.push(`By ${item.authors.join(', ')}`);
      if (item.yearPrimary) metaParts.push(item.yearPrimary);
      if (item.call_number) metaParts.push(item.call_number);
      meta.innerHTML = metaParts.join(' ¬∑ ');
      
      body.innerHTML = '';
      
      // Subjects section
      if (item.subjects && item.subjects.length) {
        const section = document.createElement('div');
        section.className = 'book-modal-section';
        
        const heading = document.createElement('h3');
        heading.textContent = 'Subjects';
        section.appendChild(heading);
        
        const subjectsDiv = document.createElement('div');
        subjectsDiv.className = 'book-modal-subjects';
        item.subjects.slice(0, 10).forEach(subj => {
          const tag = document.createElement('span');
          tag.className = 'subject-tag';
          tag.textContent = subj;
          subjectsDiv.appendChild(tag);
        });
        section.appendChild(subjectsDiv);
        body.appendChild(section);
      }
      
      // Signals section
      if (item.signals && item.signals.length) {
        const section = document.createElement('div');
        section.className = 'book-modal-section';
        
        const heading = document.createElement('h3');
        heading.textContent = 'Detected Signals';
        section.appendChild(heading);
        
        const badges = document.createElement('div');
        badges.className = 'book-modal-subjects';
        item.signals.forEach(sig => {
          const badge = document.createElement('span');
          badge.className = 'signal-badge';
          badge.textContent = SIGNAL_LABELS[sig];
          badges.appendChild(badge);
        });
        section.appendChild(badges);
        body.appendChild(section);
      }
      
      // Notes section
      if (item.sekula_notes && item.sekula_notes.length) {
        const section = document.createElement('div');
        section.className = 'book-modal-section';
        
        const heading = document.createElement('h3');
        heading.textContent = 'Notes';
        section.appendChild(heading);
        
        const desc = document.createElement('div');
        desc.className = 'book-modal-description';
        desc.textContent = item.sekula_notes.join(' | ');
        section.appendChild(desc);
        body.appendChild(section);
      }
      
      // Links section
      const linksSection = document.createElement('div');
      linksSection.className = 'book-modal-section';
      
      const linksHeading = document.createElement('h3');
      linksHeading.textContent = 'External Resources';
      linksSection.appendChild(linksHeading);
      
      const linksDiv = document.createElement('div');
      linksDiv.className = 'book-modal-links';
      
      if (item.catalogLink) {
        const link = document.createElement('a');
        link.href = item.catalogLink;
        link.className = 'modal-link';
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.innerHTML = '<span class="modal-link-icon">üèõÔ∏è</span> <span>View in Clark Catalog</span>';
        linksDiv.appendChild(link);
      }
      
      // Build WorldCat and Amazon links
      const titleQuery = encodeURIComponent(item.title || '');
      const authorQuery = item.authors && item.authors.length ? encodeURIComponent(item.authors.join(' ')) : '';
      
      const worldcatLink = document.createElement('a');
      worldcatLink.href = `https://worldcat.org/search?q=${titleQuery}${authorQuery ? '+' + authorQuery : ''}`;
      worldcatLink.className = 'modal-link';
      worldcatLink.target = '_blank';
      worldcatLink.rel = 'noopener noreferrer';
      worldcatLink.innerHTML = '<span class="modal-link-icon">üåé</span> <span>Find in WorldCat</span>';
      linksDiv.appendChild(worldcatLink);
      
      const amazonLink = document.createElement('a');
      amazonLink.href = `https://www.amazon.com/s?k=${titleQuery}${authorQuery ? '+' + authorQuery : ''}`;
      amazonLink.className = 'modal-link';
      amazonLink.target = '_blank';
      amazonLink.rel = 'noopener noreferrer';
      amazonLink.innerHTML = '<span class="modal-link-icon">üì¶</span> <span>Search on Amazon</span>';
      linksDiv.appendChild(amazonLink);
      
      linksSection.appendChild(linksDiv);
      body.appendChild(linksSection);
      
      // Update navigation buttons
      prevBtn.disabled = modalCurrentIndex <= 0;
      nextBtn.disabled = modalCurrentIndex >= modalFilteredItems.length - 1;
      
      // Update action buttons
      const addToShelfBtn = document.getElementById('addToShelf');
      const addToCartBtn = document.getElementById('addToCart');
      
      addToShelfBtn.onclick = () => addToShelf(item);
      addToCartBtn.onclick = () => addToShelf(item); // Both add to shelf for simplicity
    }

    // Initialize signal filters
    function initSignalFilters() {
      const container = document.getElementById('signalFilters');
      container.innerHTML = '';
      
      for (const signal of SIGNALS) {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.value = signal.id;
        checkbox.checked = true;
        checkbox.setAttribute('aria-label', `Filter by ${signal.label}`);
        
        checkbox.addEventListener('change', () => {
          if (checkbox.checked) {
            activeSignals.add(signal.id);
          } else {
            activeSignals.delete(signal.id);
          }
          renderShelfView();
        });
        
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(` ${signal.label}`));
        container.appendChild(label);
      }
    }

    // Initialize signal legend
    function initSignalLegend() {
      const container = document.getElementById('signalLegend');
      container.innerHTML = '';
      
      for (const item of SIGNALS) {
        const chip = document.createElement('div');
        chip.className = 'legend-chip';
        
        const symbol = document.createElement('span');
        symbol.className = 'symbol';
        symbol.setAttribute('style', `${item.legendStyle || ''}border-color:${item.color};`);
        symbol.setAttribute('aria-hidden', 'true');
        
        chip.appendChild(symbol);
        chip.appendChild(document.createTextNode(item.label));
        container.appendChild(chip);
      }
    }

    // Enrich inventory with derived fields
    function enrichInventory(rawData) {
      return rawData.map(item => {
        // Normalize core fields
        const authors = Array.isArray(item.authors) ? item.authors.filter(Boolean) : (item.authors ? [item.authors] : []);
        const subjects = Array.isArray(item.subjects) ? item.subjects.filter(Boolean) : (item.subjects ? [item.subjects] : []);
        const notes = Array.isArray(item.sekula_notes) ? item.sekula_notes : (item.sekula_notes ? [item.sekula_notes] : []);

        // Parse LC call number
        const { lcClass, lcNumber, lcKey } = parseLcCallNumber(item.call_number);
        
        // Derive signals
        const signals = deriveSignals(subjects, notes);
        
        // Normalize year
        const yearPrimary = normalizeYear(item.year);
        
        // Use catalog link from data
        const catalogLink = item.record_url || null;
        
        return {
          ...item,
          authors,
          subjects,
          sekula_notes: notes,
          lcClass,
          lcNumber,
          lcKey,
          signals,
          yearPrimary,
          catalogLink
        };
      });
    }

    // Get filtered items
    function getFilteredItems() {
      return enrichedInventory.filter(item => {
        // Signal filter
        if (activeSignals.size > 0 && activeSignals.size < SIGNAL_IDS.length) {
          const hasActiveSignal = item.signals.some(s => activeSignals.has(s));
          if (!hasActiveSignal && item.signals.length > 0) {
            return false;
          }
        }
        
        // Photo bucket filter (when overlay enabled)
        if (photoOverlayEnabled && item.photo_insert_bucket) {
          if (!activePhotoBuckets.has(item.photo_insert_bucket)) {
            return false;
          }
        }
        
        // Search filter
        const searchResult = searchState.computeMatch(item);
        item._lastMatch = searchResult;
        if (!searchResult.matches) {
          return false;
        }
        
        return true;
      });
    }

    // Group items by LC class or location
    function groupItems(items) {
      const groups = new Map();
      
      for (const item of items) {
        // Group by LC class (first letter) or "Other"
        const groupKey = item.lcClass || 'Other';
        
        if (!groups.has(groupKey)) {
          groups.set(groupKey, []);
        }
        groups.get(groupKey).push(item);
      }
      
      return Array.from(groups.entries())
        .sort((a, b) => {
          if (a[0] === 'Other') return 1;
          if (b[0] === 'Other') return -1;
          return a[0].localeCompare(b[0]);
        })
        .map(([key, items]) => ({ key, items }));
    }

    function computeCallRange(items) {
      const sorted = [...items].filter(i => i.lcKey).sort((a, b) => a.lcKey.localeCompare(b.lcKey));
      if (sorted.length === 0) return null;
      const first = sorted[0].call_number || sorted[0].lcKey;
      const last = sorted[sorted.length - 1].call_number || sorted[sorted.length - 1].lcKey;
      return `${first} ‚Äì ${last}`;
    }

    function computeTopSignals(items, limit = 3) {
      const counts = new Map();
      items.forEach(item => {
        item.signals.forEach(sig => counts.set(sig, (counts.get(sig) || 0) + 1));
      });
      return Array.from(counts.entries())
        .sort((a, b) => b[1] - a[1])
        .slice(0, limit);
    }

    // Render shelf view
    function renderShelfView() {
      const container = document.getElementById('shelfRows');
      const summary = document.getElementById('shelfSummary');
      const emptyState = document.getElementById('emptyState');
      const classLegend = document.getElementById('classLegend');
      
      container.innerHTML = '';
      
      const filtered = getFilteredItems();
      const filteredIds = new Set(filtered.map(i => i.id));
      const total = enrichedInventory.length;
      if (selectedItem && !filteredIds.has(selectedItem.id)) {
        selectedItem = null;
        selectionLost = true;
        renderDetailPanel();
      }
      
      // Update summary
      if (searchState.isActive()) {
        summary.textContent = `Showing ${filtered.length} of ${total} items (search active)`;
      } else if (activeSignals.size < SIGNAL_IDS.length) {
        summary.textContent = `Showing ${filtered.length} of ${total} items (${activeSignals.size} signals selected)`;
      } else {
        summary.textContent = `Showing all ${filtered.length} items`;
      }
      
      // Show empty state
      if (filtered.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        classLegend.classList.remove('visible');
        return;
      } else {
        container.style.display = 'flex';
        emptyState.style.display = 'none';
      }
      
      // Update class legend
      if (colorMode === 'lc_class') {
        renderClassLegend(filtered);
        classLegend.classList.add('visible');
      } else {
        classLegend.classList.remove('visible');
      }
      
      const groups = groupItems(filtered);
      
      for (const group of groups) {
        const row = document.createElement('div');
        row.className = 'shelf-row';
        row.setAttribute('role', 'region');
        row.setAttribute('aria-label', `LC Class ${group.key} shelf`);
        
        const header = document.createElement('div');
        header.className = 'shelf-header';
        
        const label = document.createElement('div');
        label.className = 'shelf-label';
        label.textContent = `LC Class ${group.key}`;
        
        const count = document.createElement('div');
        count.className = 'shelf-count';
        count.textContent = `${group.items.length} items`;
        
        header.appendChild(label);
        header.appendChild(count);
        row.appendChild(header);
        
        const spines = document.createElement('div');
        spines.className = 'spines';
        spines.setAttribute('role', 'list');
        spines.setAttribute('aria-label', `Books in ${group.key}`);
        
        for (const item of group.items) {
          const spine = document.createElement('div');
          spine.className = 'spine';
          spine.setAttribute('role', 'button');
          spine.setAttribute('tabindex', '0');
          spine.setAttribute('aria-label', `${item.title || 'Untitled'}`);
          
          // Set height based on signals count (more signals = taller)
          const height = 40 + (item.signals.length * 8);
          spine.style.height = `${height}px`;
          
          // Set color based on mode
          const dominantSignal = item.signals[0];
          spine.style.background = getSpineColor(colorMode === 'lc_class' ? 'lc_class' : 'signals', { 
            lcClass: item.lcClass, 
            signalId: dominantSignal, 
            paletteKey: activePalette 
          });
          spine.classList.remove('dimmed');
          spine.style.removeProperty('outline');
          
          // Apply signal styling from registry for consistency with legend
          const signalMeta = SIGNAL_META_MAP.get(dominantSignal);
          if (signalMeta?.legendStyle) {
            const allowedProps = new Set(['border-style', 'border-width', 'border-color', 'border-radius', 'opacity']);
            signalMeta.legendStyle.split(';').forEach(rule => {
              const [prop, value] = rule.split(':');
              const trimmedProp = prop && prop.trim();
              if (trimmedProp && value && allowedProps.has(trimmedProp)) {
                spine.style.setProperty(trimmedProp, value.trim());
              }
            });
          }
          
          // Photo overlay (subtle tint based on likelihood)
          if (photoOverlayEnabled && item.photo_insert_score != null) {
            const score = item.photo_insert_score;
            const bucket = item.photo_insert_bucket;
            
            // Apply subtle color overlay based on bucket
            let overlayColor = '';
            if (bucket === 'Strongly Likely') {
              overlayColor = 'rgba(255,165,0,0.4)'; // Orange tint
              spine.style.boxShadow = 'inset 0 0 0 2px rgba(255,140,0,0.8)';
            } else if (bucket === 'Likely') {
              overlayColor = 'rgba(255,215,0,0.3)'; // Yellow tint
              spine.style.boxShadow = 'inset 0 0 0 2px rgba(255,185,0,0.6)';
            } else if (bucket === 'Plausible') {
              overlayColor = 'rgba(135,206,250,0.2)'; // Light blue tint
              spine.style.boxShadow = 'inset 0 0 0 2px rgba(70,130,180,0.4)';
            }
            
            // Apply overlay as a blend with existing background
            if (overlayColor) {
              const currentBg = spine.style.background || '#ccc';
              spine.style.background = `linear-gradient(${overlayColor}, ${overlayColor}), ${currentBg}`;
            }
          }
          
          // Search highlighting
          if (searchState.isActive()) {
            const match = item._lastMatch || searchState.computeMatch(item);
            if (!match.matches) {
              spine.classList.add('dimmed');
            } else {
              spine.style.outline = '2px solid rgba(0,0,0,0.25)';
            }
          }
          
          // Selection
          if (selectedItem && selectedItem.id === item.id) {
            spine.classList.add('selected');
          }
          
          // Click handler - open modal instead of just updating detail panel
          const selectItem = () => {
            selectionLost = false;
            selectedItem = item;
            const filtered = getFilteredItems();
            openBookModal(item, filtered);
          };
          
          spine.addEventListener('click', selectItem);
          spine.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              selectItem();
            }
          });
          
          spines.appendChild(spine);
        }
        
        row.appendChild(spines);
        container.appendChild(row);
      }
    }

    // Render class legend
    function renderClassLegend(items) {
      const container = document.getElementById('classLegend');
      container.innerHTML = '';
      
      const classes = new Set(items.map(i => i.lcClass).filter(Boolean));
      const sorted = Array.from(classes).sort();
      
      const heading = document.createElement('div');
      heading.style.fontWeight = '700';
      heading.style.fontSize = '0.85rem';
      heading.style.marginBottom = '0.35rem';
      heading.textContent = 'LC Class Colors';
      container.appendChild(heading);
      
      for (const lcClass of sorted) {
        const chip = document.createElement('div');
        chip.className = 'class-chip';
        
        const swatch = document.createElement('div');
        swatch.className = 'swatch';
        swatch.style.background = getSpineColor('lc_class', { 
          lcClass, 
          paletteKey: activePalette 
        });
        
        chip.appendChild(swatch);
        chip.appendChild(document.createTextNode(lcClass));
        container.appendChild(chip);
      }
    }

    // Render detail panel
    function renderDetailPanel() {
      const intro = document.getElementById('detailIntro');
      const body = document.getElementById('detailBody');
      
      if (!selectedItem) {
        intro.style.display = 'block';
        intro.textContent = selectionLost
          ? 'The previously selected item is no longer visible under current filters.'
          : 'Click on a spine to see details.';
        body.innerHTML = '';
        return;
      }
      
      intro.style.display = 'none';
      body.innerHTML = '';
      
      // Find peer items in the same LC class to populate range + samples
      const peerItems = enrichedInventory.filter(i => (i.lcClass || 'Other') === (selectedItem.lcClass || 'Other'));
      const callRange = computeCallRange(peerItems);
      const topSignals = computeTopSignals(peerItems);
      const totalVolumes = peerItems.length;

      // Title and metadata section
      const titleSection = document.createElement('div');
      titleSection.className = 'detail-section';
      
      const title = document.createElement('h3');
      title.textContent = selectedItem.title || 'Untitled';
      title.style.fontSize = '1rem';
      title.style.color = 'var(--primary)';
      title.style.marginBottom = '0.5rem';
      titleSection.appendChild(title);
      
      const meta = document.createElement('div');
      meta.className = 'detail-meta';
      
      const metaParts = [];
      if (selectedItem.authors && selectedItem.authors.length > 0) {
        metaParts.push(`By: ${selectedItem.authors.join(', ')}`);
      }
      if (selectedItem.yearPrimary) {
        metaParts.push(`Year: ${selectedItem.yearPrimary}`);
      }
      if (selectedItem.lcClass) {
        metaParts.push(`LC Class: ${selectedItem.lcClass}${selectedItem.lcNumber ? ' ' + selectedItem.lcNumber : ''}`);
      }
      if (callRange) {
        metaParts.push(`Call range: ${callRange}`);
      }
      metaParts.push(`Volumes in class: ${totalVolumes}`);
      
      meta.innerHTML = metaParts.join('<br>');
      titleSection.appendChild(meta);
      
      body.appendChild(titleSection);
      
      // Photo likelihood section (always show when metadata is present)
      if (selectedItem.photo_insert_score != null || selectedItem.photo_insert_bucket || selectedItem.photo_insert_reasoning) {
        const photoSection = document.createElement('div');
        photoSection.className = 'detail-section';
        photoSection.style.background = 'var(--surface-alt)';
        photoSection.style.border = `1px solid var(--border)`;
        photoSection.style.borderRadius = '0.6rem';
        photoSection.style.padding = '0.75rem';
        
        const heading = document.createElement('h3');
        heading.textContent = 'üì∑ Embedded Photography Likelihood';
        heading.style.fontSize = '0.9rem';
        heading.style.marginBottom = '0.4rem';
        photoSection.appendChild(heading);
        
        const scoreDiv = document.createElement('div');
        scoreDiv.style.fontSize = '0.85rem';
        scoreDiv.style.marginBottom = '0.3rem';
        const bucket = selectedItem.photo_insert_bucket || 'Not classified';
        const scoreText = Number.isFinite(selectedItem.photo_insert_score) ? `${selectedItem.photo_insert_score}/100` : 'n/a';
        scoreDiv.innerHTML = `<strong>Score:</strong> ${scoreText}${bucket ? ` (${bucket})` : ''}`;
        photoSection.appendChild(scoreDiv);
        
        if (selectedItem.photo_insert_reasoning) {
          const reasonDiv = document.createElement('div');
          reasonDiv.style.fontSize = '0.8rem';
          reasonDiv.style.color = 'var(--muted)';
          reasonDiv.style.fontStyle = 'italic';
          reasonDiv.textContent = selectedItem.photo_insert_reasoning;
          photoSection.appendChild(reasonDiv);
        }
        
        body.appendChild(photoSection);
      }
      
      // Signals section with top signals for the class
      if (topSignals.length > 0) {
        const signalsSection = document.createElement('div');
        signalsSection.className = 'detail-section';
        
        const heading = document.createElement('h3');
        heading.textContent = 'Top signals in this class';
        signalsSection.appendChild(heading);
        
        const badges = document.createElement('div');
        for (const [signal, count] of topSignals) {
          const badge = document.createElement('span');
          badge.className = 'signal-badge';
          badge.textContent = `${SIGNAL_LABELS[signal]} ¬∑ ${count}`;
          badges.appendChild(badge);
        }
        signalsSection.appendChild(badges);
        
        body.appendChild(signalsSection);
      }
      
      // Subjects section
      if (selectedItem.subjects && selectedItem.subjects.length > 0) {
        const subjectsSection = document.createElement('div');
        subjectsSection.className = 'detail-section';
        
        const heading = document.createElement('h3');
        heading.textContent = 'Subjects';
        subjectsSection.appendChild(heading);
        
        const list = document.createElement('div');
        list.className = 'detail-meta';
        list.textContent = selectedItem.subjects.slice(0, 5).join('; ');
        subjectsSection.appendChild(list);
        
        body.appendChild(subjectsSection);
      }
      
      // Sample titles
      const samplesSection = document.createElement('div');
      samplesSection.className = 'detail-section';
      const sampleHeading = document.createElement('h3');
      sampleHeading.textContent = 'Sample titles';
      samplesSection.appendChild(sampleHeading);

      const searchActive = searchState.isActive();
      const samplePool = peerItems.slice(0, MAX_SAMPLE_POOL_SIZE);
      const sortedSamples = samplePool.sort((a, b) => {
        const aMatch = a._lastMatch && a._lastMatch.matches ? 1 : 0;
        const bMatch = b._lastMatch && b._lastMatch.matches ? 1 : 0;
        if (bMatch !== aMatch) return bMatch - aMatch;
        if (a.yearPrimary && b.yearPrimary) return a.yearPrimary - b.yearPrimary;
        return (a.lcKey || '').localeCompare(b.lcKey || '');
      }).slice(0, MAX_SAMPLE_TITLES);

      const listEl = document.createElement('div');
      listEl.style.display = 'flex';
      listEl.style.flexDirection = 'column';
      listEl.style.gap = '0.4rem';

      if (sortedSamples.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'detail-meta';
        empty.textContent = 'No sample titles available.';
        listEl.appendChild(empty);
      } else {
        for (const sample of sortedSamples) {
          const row = document.createElement('div');
          row.className = 'detail-item';

          const titleLine = document.createElement('div');
          titleLine.className = 'detail-title';
          titleLine.textContent = sample.title || 'Untitled';
          row.appendChild(titleLine);

          const metaLine = document.createElement('div');
          metaLine.className = 'detail-meta';
          const bits = [];
          if (sample.yearPrimary) bits.push(sample.yearPrimary);
          if (sample.authors && sample.authors.length) bits.push(sample.authors.join(', '));
          if (searchActive && sample._lastMatch?.matches) bits.push('Matches search');
          metaLine.textContent = bits.join(' ¬∑ ');
          row.appendChild(metaLine);

          if (sample.signals && sample.signals.length) {
            const badgeRow = document.createElement('div');
            for (const sig of sample.signals) {
              const badge = document.createElement('span');
              badge.className = 'signal-badge';
              badge.textContent = SIGNAL_LABELS[sig];
              badgeRow.appendChild(badge);
            }
            row.appendChild(badgeRow);
          }

          if (sample.catalogLink) {
            const link = document.createElement('a');
            link.href = sample.catalogLink;
            link.className = 'link-button';
            link.target = '_blank';
            link.rel = 'noopener noreferrer';
            link.textContent = 'Open in Clark catalog';
            row.appendChild(link);
          }

          listEl.appendChild(row);
        }
      }

      samplesSection.appendChild(listEl);
      body.appendChild(samplesSection);
      
      // Links section
      const linksSection = document.createElement('div');
      linksSection.className = 'detail-section';
      
      const heading = document.createElement('h3');
      heading.textContent = 'Links';
      linksSection.appendChild(heading);
      
      if (selectedItem.catalogLink) {
        const link = document.createElement('a');
        link.href = selectedItem.catalogLink;
        link.className = 'link-button';
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = 'View in Catalog';
        linksSection.appendChild(link);
      }
      
      body.appendChild(linksSection);
    }

    // Render palette grid
    function renderPaletteGrid() {
      const grid = document.getElementById('paletteGrid');
      grid.innerHTML = '';
      
      const palettes = getPalettes();
      
      for (const [key, palette] of Object.entries(palettes)) {
        const card = document.createElement('div');
        card.className = 'palette-card';
        card.dataset.active = key === activePalette ? 'true' : 'false';
        card.setAttribute('role', 'button');
        card.setAttribute('tabindex', '0');
        card.setAttribute('aria-label', `Select ${palette.label} palette`);
        
        const title = document.createElement('div');
        title.textContent = palette.label;
        title.style.fontWeight = '600';
        title.style.fontSize = '0.95rem';
        card.appendChild(title);
        
        const swatchRow = document.createElement('div');
        swatchRow.className = 'swatch-row';
        
        // Show first 6 colors
        const colors = Object.values(palette.colors).slice(0, 6);
        for (const color of colors) {
          const swatch = document.createElement('div');
          swatch.className = 'swatch-square';
          swatch.style.background = color;
          swatchRow.appendChild(swatch);
        }
        
        card.appendChild(swatchRow);
        
        const selectPalette = () => {
          activePalette = setActivePalette(key);
          renderPaletteGrid();
          renderShelfView();
        };
        
        card.addEventListener('click', selectPalette);
        card.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            selectPalette();
          }
        });
        
        grid.appendChild(card);
      }
    }

    // Initialize event handlers
    function initEventHandlers() {
      const themeToggle = document.getElementById('toggleTheme');
      if (themeToggle) {
        themeToggle.addEventListener('click', () => {
          const next = document.body.dataset.theme === 'dark' ? 'light' : 'dark';
          applyTheme(next);
        });
      }

      // Search
      const searchBox = document.getElementById('searchBox');
      const searchClear = document.getElementById('searchClear');
      const searchMeta = document.getElementById('searchMeta');
      
      searchBox.addEventListener('input', () => {
        searchState.setQuery(searchBox.value);
        searchClear.classList.toggle('visible', searchBox.value.length > 0);
      });
      
      searchBox.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          searchBox.value = '';
          searchState.clear();
          searchClear.classList.remove('visible');
        }
      });
      
      searchClear.addEventListener('click', () => {
        searchBox.value = '';
        searchState.clear();
        searchClear.classList.remove('visible');
        searchBox.focus();
      });
      
      searchState.addListener((query) => {
        renderShelfView();
        if (query) {
          const filtered = getFilteredItems();
          searchMeta.textContent = `${filtered.length} matches`;
        } else {
          searchMeta.textContent = '';
        }
      });
      
      // Color toggle
      const toggleClassColors = document.getElementById('toggleClassColors');
      toggleClassColors.addEventListener('change', () => {
        colorMode = toggleClassColors.checked ? 'lc_class' : 'signals';
        renderShelfView();
      });
      
      // Photo overlay toggle
      const togglePhotoOverlay = document.getElementById('togglePhotoOverlay');
      const photoFilterGroup = document.getElementById('photoFilterGroup');
      const photoLegend = document.getElementById('photoLegend');
      
      togglePhotoOverlay.addEventListener('change', () => {
        photoOverlayEnabled = togglePhotoOverlay.checked;
        photoFilterGroup.style.display = photoOverlayEnabled ? 'block' : 'none';
        photoLegend.style.display = photoOverlayEnabled ? 'block' : 'none';
        renderShelfView();
      });
      
      // Photo bucket filters
      const photoBucketCheckboxes = document.querySelectorAll('.photo-bucket-filter');
      photoBucketCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          activePhotoBuckets.clear();
          photoBucketCheckboxes.forEach(cb => {
            if (cb.checked) {
              activePhotoBuckets.add(cb.value);
            }
          });
          renderShelfView();
        });
      });
      
      // Config dialog
      const openConfig = document.getElementById('openConfig');
      const closeConfig = document.getElementById('closeConfig');
      const backdrop = document.getElementById('configBackdrop');
      
      openConfig.addEventListener('click', () => {
        renderPaletteGrid();
        backdrop.style.display = 'flex';
        closeConfig.focus(); // Focus trap
      });
      
      closeConfig.addEventListener('click', () => {
        backdrop.style.display = 'none';
        openConfig.focus();
      });
      
      backdrop.addEventListener('click', (e) => {
        if (e.target === backdrop) {
          backdrop.style.display = 'none';
          openConfig.focus();
        }
      });
      
      // About dialog
      const openAbout = document.getElementById('openAbout');
      const closeAbout = document.getElementById('closeAbout');
      const aboutBackdrop = document.getElementById('aboutBackdrop');
      
      openAbout.addEventListener('click', () => {
        aboutBackdrop.style.display = 'flex';
        closeAbout.focus();
      });
      
      closeAbout.addEventListener('click', () => {
        aboutBackdrop.style.display = 'none';
        openAbout.focus();
      });
      
      aboutBackdrop.addEventListener('click', (e) => {
        if (e.target === aboutBackdrop) {
          aboutBackdrop.style.display = 'none';
          openAbout.focus();
        }
      });
      
      // Book Modal
      const closeBookModalBtn = document.getElementById('closeBookModal');
      const bookModalBackdrop = document.getElementById('bookModalBackdrop');
      const modalPrevBook = document.getElementById('modalPrevBook');
      const modalNextBook = document.getElementById('modalNextBook');
      
      closeBookModalBtn.addEventListener('click', closeBookModal);
      
      bookModalBackdrop.addEventListener('click', (e) => {
        if (e.target === bookModalBackdrop) {
          closeBookModal();
        }
      });
      
      modalPrevBook.addEventListener('click', () => navigateModal(-1));
      modalNextBook.addEventListener('click', () => navigateModal(1));
      
      // Cart/Shelf Panel
      const openCart = document.getElementById('openCart');
      const closeCart = document.getElementById('closeCart');
      const cartPanel = document.getElementById('cartPanel');
      const clearCart = document.getElementById('clearCart');
      const exportCart = document.getElementById('exportCart');
      
      openCart.addEventListener('click', () => {
        cartPanel.classList.add('active');
        renderCartPanel();
      });
      
      closeCart.addEventListener('click', () => {
        cartPanel.classList.remove('active');
      });
      
      clearCart.addEventListener('click', () => clearShelf());
      exportCart.addEventListener('click', () => exportShelf());
      
      // ESC to close dialogs
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          if (bookModalBackdrop.classList.contains('active')) {
            closeBookModal();
          } else if (cartPanel.classList.contains('active')) {
            cartPanel.classList.remove('active');
          } else if (aboutBackdrop.style.display === 'flex') {
            aboutBackdrop.style.display = 'none';
            openAbout.focus();
          } else if (backdrop.style.display === 'flex') {
            backdrop.style.display = 'none';
            openConfig.focus();
          }
        } else if (e.key === 'ArrowLeft' && bookModalBackdrop.classList.contains('active')) {
          navigateModal(-1);
        } else if (e.key === 'ArrowRight' && bookModalBackdrop.classList.contains('active')) {
          navigateModal(1);
        }
      });
    }

    // Load data and initialize
    async function init() {
      initTheme();
      const loading = document.getElementById('loadingOverlay');
      loading.style.display = 'flex';
      
      try {
        // Load JSON data
        const response = await fetch('../data/sekula_index.json');
        if (!response.ok) {
          throw new Error('Failed to load data');
        }
        
        const data = await response.json();
        inventory = Array.isArray(data) ? data : (data.items || []);
        
        // Filter for Sekula Library collection
        inventory = inventory.filter(item => 
          (item.collection || '').includes('Allan Sekula Library') ||
          (item.collection_tags && item.collection_tags.some(tag => tag.includes('Sekula')))
        );
        
        // Enrich inventory
        enrichedInventory = enrichInventory(inventory);
        
        // Initialize UI
        shelf = loadShelf();
        updateCartBadge();
        initSignalFilters();
        initSignalLegend();
        initEventHandlers();
        
        // Initial render
        renderShelfView();
        
        loading.style.display = 'none';
      } catch (err) {
        console.error('Failed to load data:', err);
        loading.innerHTML = '<div style="color:red;margin-bottom:0.5rem;">Failed to load Sekula data - check your connection and try again.</div>';
        const retry = document.createElement('button');
        retry.className = 'link-button';
        retry.textContent = 'Retry';
        retry.addEventListener('click', () => {
          loading.innerHTML = '<div>Retrying‚Ä¶</div>';
          init();
        });
        loading.appendChild(retry);
      }
    }

    // Start
    init();
  </script>
</body>
</html>
